<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
</head>

<body>
    <div id="message"></div>
    <button id="token">Get Token</button>
    <button id="dialog">Get Token (via dialog)</button>
    <button id="forget">Forget Token</button>
    <button id="signout">Logout of IdentityServer</button>
    <button id="protected">Protected</button>
    <button id="unprotected">Unprotected</button>
    <pre id="result"></pre>
    <script src="jquery-2.1.0.min.js"></script>
    <script src="oidc-token-manager.js"></script>
    <script>
        $(function () {
            var config = {
                authority: "https://accounts.google.com",
                client_id: "342665198077-1fdticgpjke40gddj3r8vghltpgcvb5m.apps.googleusercontent.com",
                redirect_uri: window.location.protocol + "//" + window.location.host + "/callback.html",
                post_logout_redirect_uri: window.location.protocol + "//" + window.location.host + "/index.html",
                response_type: "id_token token",
                scope: "email",
                silent_redirect_uri: window.location.protocol + "//" + window.location.host + "/frame.html",
                popup_redirect_uri: window.location.protocol + "//" + window.location.host + "/popup.html",
                jwks: {
                    keys: [{
                        kty: "RSA",
                        x5c: ["-----BEGIN CERTIFICATE-----\nMIIDJjCCAg6gAwIBAgIIEdYESwWShuUwDQYJKoZIhvcNAQEFBQAwNjE0MDIGA1UE\nAxMrZmVkZXJhdGVkLXNpZ25vbi5zeXN0ZW0uZ3NlcnZpY2VhY2NvdW50LmNvbTAe\nFw0xNjA0MDcwNjI4MzRaFw0xNjA0MDgxOTI4MzRaMDYxNDAyBgNVBAMTK2ZlZGVy\nYXRlZC1zaWdub24uc3lzdGVtLmdzZXJ2aWNlYWNjb3VudC5jb20wggEiMA0GCSqG\nSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC+7OuWoJxMJHiF9pYER5zWje+2n9WkExsr\nGFNLzsQnSX07pSw07rsFcsRAUDWufpzUf6M+JWUTvgTBhMQN4gv0tWZjzxkrWu9n\n7xWBogaedfe2xEkKkioXhm35MHK2Ig6DWLUDKKvx4CZxJhTlhrFb/lmUvUZUIrDE\nZWjHVUvYuZAPbkj5N8ylJXYHLbm5YgYJ179qepPMoDS3HlHU8ZKu9E/gjsxPNX87\n5PUrCT0gUfjhVZKjpx6c71eKbm5UfEdjM0lKz5pBXj6yM9C+vjI5m1bQu+3gkWGh\nmqtxx1icK8YlMnXjvD1X27PmVivlOF04gpLWsZQWnf08EAnVBH5LAgMBAAGjODA2\nMAwGA1UdEwEB/wQCMAAwDgYDVR0PAQH/BAQDAgeAMBYGA1UdJQEB/wQMMAoGCCsG\nAQUFBwMCMA0GCSqGSIb3DQEBBQUAA4IBAQAAtr/6NQHnOlLQHEMRYNGcz7fqZoAW\nULaygU1/SpRDtHVuOl9A0N+zeWBHzKxVrRJgZcM9PhfF/iViaUFo1DXqQvmc6F4x\n7P9qLVTX9+uyaVedFeOpQ58mWowzBbp8Wh9N5qlHuia2kAhTHSOPwkoYmsPoRb2Q\n6MKSFdw4WexB3PxPCpGzW6/WR8HEH+feAA1qD9QNVOe9DSSed3WnCnKTRWoyUx+q\neU/tuavsI0EsltTRDlGetwxuM3M9eqcsE2oJKLNeQIfSxc7gSMi33j2LFJqSP0FG\naFZmyHUb7kQ42BecJLb+tQWta37Fdxd4i5QG09/WREJF1abHAZPMLjjl\n-----END CERTIFICATE-----\n"]
                    }]
                },
                load_user_profile : false,
                silent_renew: true
            };
            var mgr = new OidcTokenManager(config);
            window.mgr = mgr;

            if (!mgr.expired) {
                console.log("Token loaded, expires in: ", mgr.expires_in);
                console.log("profile", mgr.profile);
                console.log("access_token", !!mgr.access_token);
            }
            else {
                console.log("No token loaded");
            }

            mgr.addOnTokenObtained(function () {
                console.log("token obtained, scopes: ", mgr.scopes);
            });
            mgr.addOnTokenRemoved(function () {
                console.log("token removed");
            });
            mgr.addOnTokenExpiring(function () {
                console.log("token is about to expire");
                //mgr.renewTokenSilent();
            });
            mgr.addOnTokenExpired(function () {
                $("#message").text("your session is expired");
                console.log("token expired");
            });

            $("#token").click(function () {
                mgr.redirectForToken();
            });

            $("#dialog").click(function () {
                mgr.openPopupForTokenAsync().then(function () {
                    console.log('popup success');
                }, function (err) {
                    console.log('popup error: ', err);
                });
            });

            $("#forget").click(function () {
                mgr.removeToken();
            });

            $("#signout").click(function () {
                mgr.redirectForLogout();
            });

            function toggleForget() {
                $("#forget").prop("disabled", mgr.expired);
            }
            $("#protected").click(function () {
                $.ajax({
                    url: 'api/values',
                    type: 'GET',
                    dataType: "json",
                    beforeSend: function (xhr) {
                        console.log(mgr.access_token);
                        xhr.setRequestHeader('Authorization', 'Bearer ' + mgr.id_token);
                    },
                    data: {},
                    success:  function( data ) {
                        $( "#result" ).html( data );
                    },
                    error: function (err) {console.log(err.responseText); }
                });
             });

            $("#unprotected").click(function () {
                $.ajax({
                    url: 'api/publicvalues',
                    type: 'GET',
                    dataType: "json",
                    data: {},
                    success: function (data) {
                        $("#result").html(data);
                    },
                    error: function (err) { console.log(err.responseText); }
                });
            });
            mgr.addOnTokenObtained(toggleForget);
            mgr.addOnTokenRemoved(toggleForget);
            toggleForget();
        });
    </script>
</body>

</html>